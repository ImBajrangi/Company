<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vrindopnishad Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen">

    <div id="app-container" class="w-full h-full flex">
        <!-- User Setup Modal -->
        <div id="user-setup-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-md">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Welcome to Vrindopnishad</h2>
                <p class="text-center text-gray-500 mb-6">Let's get you set up.</p>
                <div class="space-y-4">
                    <input type="text" id="display-name-input" placeholder="Enter your full name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <div>
                        <p class="text-gray-600 mb-2 font-medium">Select your role:</p>
                        <div class="flex space-x-4">
                            <button id="role-employee-btn" class="flex-1 py-3 px-4 border-2 border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-blue-50 hover:border-blue-500 transition">Employee</button>
                            <button id="role-customer-btn" class="flex-1 py-3 px-4 border-2 border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-green-50 hover:border-green-500 transition">Customer</button>
                        </div>
                    </div>
                    <button id="save-profile-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Start Chatting
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Chat Interface -->
        <div class="flex h-full w-full hidden" id="main-chat-interface">
            <!-- Sidebar -->
            <aside class="w-full md:w-1/3 lg:w-1/4 h-screen bg-white border-r border-gray-200 flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <h1 class="text-2xl font-bold text-blue-600">Vrindopnishad</h1>
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-600">Your User ID:</p>
                        <p id="current-user-id" class="text-xs text-gray-800 font-mono break-all cursor-pointer" title="Click to copy"></p>
                    </div>
                </div>

                <div class="flex-grow overflow-y-auto">
                    <!-- Employee List -->
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Employees</h3>
                        <div id="employee-list" class="space-y-2">
                            <!-- Employee items will be injected here -->
                        </div>
                    </div>

                    <!-- Customer List -->
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Customers</h3>
                        <div id="customer-list" class="space-y-2">
                            <!-- Customer items will be injected here -->
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="w-full md:w-2/3 lg:w-3/4 h-screen flex flex-col bg-gray-50">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center">
                    <svg class="w-24 h-24 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2s10 4.477 10 10z"></path></svg>
                    <h2 class="text-2xl font-semibold text-gray-700">Welcome to Vrindopnishad Chat</h2>
                    <p class="text-gray-500 mt-2">Select a person from the list on the left to start a conversation.</p>
                </div>
                <div id="chat-container" class="hidden flex-col h-full">
                    <!-- Chat Header -->
                    <header class="bg-white p-4 border-b border-gray-200 flex items-center">
                        <div id="chat-header-avatar" class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xl mr-3"></div>
                        <div>
                            <h3 id="chat-header-name" class="font-semibold text-gray-800"></h3>
                            <p id="chat-header-role" class="text-sm text-gray-500"></p>
                        </div>
                    </header>

                    <!-- Messages -->
                    <div id="chat-messages" class="flex-1 p-6 overflow-y-auto">
                        <!-- Messages will be injected here -->
                    </div>

                    <!-- Message Input -->
                    <footer class="p-4 bg-white border-t border-gray-200">
                        <form id="message-form" class="flex items-center space-x-3">
                            <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" class="w-full py-2 px-4 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" class="bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </button>
                        </form>
                    </footer>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & CONFIG ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vrindopnishad-chat';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let db, auth;
        let currentUserId = null;
        let currentUserProfile = null;
        let activeChatId = null;
        let unsubscribeMessages = null;

        // --- DOM ELEMENTS ---
        const userSetupModal = document.getElementById('user-setup-modal');
        const mainChatInterface = document.getElementById('main-chat-interface');
        const displayNameInput = document.getElementById('display-name-input');
        const roleEmployeeBtn = document.getElementById('role-employee-btn');
        const roleCustomerBtn = document.getElementById('role-customer-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const currentUserIdElem = document.getElementById('current-user-id');
        const employeeList = document.getElementById('employee-list');
        const customerList = document.getElementById('customer-list');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatContainer = document.getElementById('chat-container');
        const chatHeaderName = document.getElementById('chat-header-name');
        const chatHeaderRole = document.getElementById('chat-header-role');
        const chatHeaderAvatar = document.getElementById('chat-header-avatar');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        
        // --- INITIALIZATION ---
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuthListener();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // Display error to user
            }
        }

        // --- AUTHENTICATION ---
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    currentUserIdElem.textContent = currentUserId;
                    // Check if user profile exists
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/${currentUserId}`);
                    onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            currentUserProfile = docSnap.data();
                            userSetupModal.classList.add('hidden');
                            mainChatInterface.classList.remove('hidden');
                            listenForUsers();
                        } else {
                            // New user, show setup modal
                            userSetupModal.classList.remove('hidden');
                            mainChatInterface.classList.add('hidden');
                        }
                    });
                } else {
                    // No user, sign in
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                    }
                }
            });
        }
        
        // --- USER PROFILE SETUP ---
        let selectedRole = '';
        roleEmployeeBtn.addEventListener('click', () => {
            selectedRole = 'Employee';
            roleEmployeeBtn.classList.add('border-blue-500', 'bg-blue-50');
            roleCustomerBtn.classList.remove('border-green-500', 'bg-green-50');
            validateProfileForm();
        });
        roleCustomerBtn.addEventListener('click', () => {
            selectedRole = 'Customer';
            roleCustomerBtn.classList.add('border-green-500', 'bg-green-50');
            roleEmployeeBtn.classList.remove('border-blue-500', 'bg-blue-50');
            validateProfileForm();
        });
        displayNameInput.addEventListener('input', validateProfileForm);
        
        function validateProfileForm() {
             saveProfileBtn.disabled = !(displayNameInput.value.trim() && selectedRole);
        }

        saveProfileBtn.addEventListener('click', async () => {
            if (saveProfileBtn.disabled) return;
            
            const displayName = displayNameInput.value.trim();
            const userProfile = {
                displayName,
                role: selectedRole,
                uid: currentUserId,
            };

            try {
                const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/${currentUserId}`);
                await setDoc(userDocRef, userProfile);
                // Modal will be hidden by the onSnapshot listener
            } catch (error) {
                console.error("Error saving profile:", error);
            }
        });
        
        currentUserIdElem.addEventListener('click', () => {
            navigator.clipboard.writeText(currentUserId).then(() => {
                const originalText = currentUserIdElem.textContent;
                currentUserIdElem.textContent = 'Copied!';
                setTimeout(() => {
                    currentUserIdElem.textContent = originalText;
                }, 1500);
            });
        });

        // --- USER LISTING ---
        function listenForUsers() {
            const usersCollectionRef = collection(db, `/artifacts/${appId}/public/data/users`);
            onSnapshot(usersCollectionRef, (snapshot) => {
                employeeList.innerHTML = '';
                customerList.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.uid === currentUserId) return; // Don't list self

                    const userElement = document.createElement('div');
                    userElement.className = 'flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-100';
                    userElement.dataset.uid = user.uid;
                    userElement.dataset.name = user.displayName;
                    userElement.dataset.role = user.role;
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-bold text-gray-700 mr-3';
                    avatar.textContent = user.displayName.charAt(0).toUpperCase();

                    const userInfo = document.createElement('div');
                    const name = document.createElement('p');
                    name.className = 'font-semibold text-gray-800';
                    name.textContent = user.displayName;
                    userInfo.appendChild(name);

                    userElement.appendChild(avatar);
                    userElement.appendChild(userInfo);
                    
                    userElement.addEventListener('click', () => startChat(user));
                    
                    if (user.role === 'Employee') {
                        employeeList.appendChild(userElement);
                    } else {
                        customerList.appendChild(userElement);
                    }
                });
            });
        }
        
        // --- CHAT FUNCTIONALITY ---
        function startChat(otherUser) {
            welcomeScreen.classList.add('hidden');
            chatContainer.classList.remove('hidden');
            chatContainer.classList.add('flex');

            // Set chat header
            chatHeaderName.textContent = otherUser.displayName;
            chatHeaderRole.textContent = otherUser.role;
            chatHeaderAvatar.textContent = otherUser.displayName.charAt(0).toUpperCase();
            if (otherUser.role === 'Employee') {
                 chatHeaderAvatar.className = 'w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xl mr-3';
            } else {
                 chatHeaderAvatar.className = 'w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold text-xl mr-3';
            }
            
            // Generate a consistent chat ID
            const chatParticipants = [currentUserId, otherUser.uid].sort();
            activeChatId = chatParticipants.join('_');
            
            // Unsubscribe from previous chat listener if it exists
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }

            // Listen for messages in the new chat
            const messagesCollectionRef = collection(db, `/artifacts/${appId}/public/data/chats/${activeChatId}/messages`);
            const q = query(messagesCollectionRef, orderBy('timestamp'));
            
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    renderMessage(doc.data());
                });
                scrollToBottom();
            });
        }

        function renderMessage(message) {
            const isSender = message.senderId === currentUserId;
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex mb-4 ${isSender ? 'justify-end' : 'justify-start'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ${isSender ? 'bg-blue-600 text-white' : 'bg-white text-gray-800'}`;
            messageBubble.textContent = message.text;
            
            messageWrapper.appendChild(messageBubble);
            chatMessages.appendChild(messageWrapper);
        }

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (text && activeChatId) {
                const messagesCollectionRef = collection(db, `/artifacts/${appId}/public/data/chats/${activeChatId}/messages`);
                try {
                    await addDoc(messagesCollectionRef, {
                        text,
                        senderId: currentUserId,
                        timestamp: serverTimestamp()
                    });
                    messageInput.value = '';
                    scrollToBottom();
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            }
        });

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // --- START THE APP ---
        window.onload = initialize;
    </script>
</body>
</html>