<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vrindopnishad Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Generation & Scanning Libraries -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-track { background: #f1f1f1; }
        #chat-messages::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        #chat-messages::-webkit-scrollbar-thumb:hover { background: #555; }
        #qr-reader { border: 2px solid #e5e7eb; border-radius: 8px; }
        .hidden { display: none !important; }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9E9E9E;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Mobile Responsive Styles */
        @media (max-width: 767px) {
            #sidebar {
                transition: transform 0.3s ease-in-out;
                width: 100%;
                position: absolute;
                z-index: 10;
            }
            #chat-area {
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                z-index: 20;
            }
            #main-chat-interface.chat-view-active #sidebar {
                transform: translateX(-100%);
            }
            #main-chat-interface.chat-view-active #chat-area {
                transform: translateX(0);
            }
        }
        /* Video Call Styles */
        #local-video {
            transform: scaleX(-1); /* Mirror local video */
        }
        #remote-video {
            transform: scaleX(-1); /* Mirror remote video for a more natural feel */
        }
    </style>
</head>
<body class="bg-gray-100 h-screen">

    <div id="app-container" class="w-full h-full flex">
        <!-- Loading / Login Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-[100]">
            <div class="text-center max-w-2xl mx-auto p-8">
                 <!-- Loader -->
                <div id="loader" class="mb-6">
                    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-2 text-gray-600">Connecting...</p>
                </div>

                <!-- Login / Signup Modal -->
                <div id="auth-modal" class="hidden bg-white rounded-lg shadow-2xl w-full max-w-sm text-left">
                    <div class="flex border-b">
                        <button id="login-tab" class="flex-1 p-4 font-semibold text-center bg-gray-100 border-b-2 border-blue-600">Login</button>
                        <button id="signup-tab" class="flex-1 p-4 font-semibold text-center text-gray-500">Sign Up</button>
                    </div>
                    <!-- Login Form -->
                    <form id="login-form" class="p-6 space-y-4">
                        <input type="email" id="login-email" placeholder="Email Address" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">Login</button>
                        <p id="login-error" class="text-sm text-red-500 text-center"></p>

                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>

                        <button type="button" id="google-login-btn" class="w-full flex justify-center items-center py-2 px-4 border border-gray-300 rounded-lg shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                            Sign in with Google
                        </button>
                    </form>
                    <!-- Signup Form -->
                    <form id="signup-form" class="p-6 space-y-4 hidden">
                        <input type="text" id="signup-name" placeholder="Full Name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="email" id="signup-email" placeholder="Email Address" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                         <div>
                            <p class="text-gray-600 mb-2 text-sm font-medium">Select your role:</p>
                            <select id="signup-role" class="w-full px-4 py-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Customer">Customer</option>
                                <option value="Employee">Employee</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">Create Account</button>
                        <p id="signup-error" class="text-sm text-red-500 text-center"></p>
                        
                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>

                        <button type="button" id="google-signup-btn" class="w-full flex justify-center items-center py-2 px-4 border border-gray-300 rounded-lg shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                            Sign up with Google
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- All Modals -->
        <div id="modal-container" class="z-50">
            <!-- Incoming Call Modal -->
            <div id="incoming-call-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
                <div class="bg-white rounded-lg p-6 shadow-2xl w-full max-w-sm text-center">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Incoming <span id="call-type-text" class="capitalize"></span> Call</h3>
                    <p class="text-gray-600 mb-6">from <span id="caller-name" class="font-bold"></span></p>
                    <div class="flex justify-center space-x-4">
                        <button id="decline-call-btn" class="flex-1 bg-red-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-red-700 transition">Decline</button>
                        <button id="accept-call-btn" class="flex-1 bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition">Accept</button>
                    </div>
                </div>
            </div>
            <!-- AI Suggestion Modal -->
            <div id="ai-suggestion-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
                <div class="bg-white rounded-lg p-6 shadow-2xl w-11/12 max-w-2xl">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">✨ AI Reply Suggestions</h3>
                    <div id="suggestion-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
                    <button id="close-suggestion-modal" class="mt-6 w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition">Close</button>
                </div>
            </div>
            <!-- AI Polish Modal -->
            <div id="ai-polish-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
                <div class="bg-white rounded-lg p-6 shadow-2xl w-11/12 max-w-2xl">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">✨ Polished Message</h3>
                    <p class="text-sm text-gray-500 mb-4">Here is a more professional version of your message:</p>
                    <div id="polished-text-container" class="p-4 bg-gray-100 rounded-lg text-gray-800 max-h-[60vh] overflow-y-auto"></div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="cancel-polish" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition">Keep Original</button>
                        <button id="use-polished-text" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition">Use This Version</button>
                    </div>
                </div>
            </div>
            <!-- Delete Confirmation Modal -->
            <div id="confirm-delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
                <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-sm text-center">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Delete Chat?</h3>
                    <p class="text-gray-600 mb-6">Are you sure you want to permanently delete this conversation? This action cannot be undone.</p>
                    <div class="flex justify-center space-x-4">
                        <button id="cancel-delete-btn" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel</button>
                        <button id="confirm-delete-btn" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition">Delete</button>
                    </div>
                </div>
            </div>
            <!-- QR Code Modals -->
            <div id="qr-code-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
                <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-sm text-center"><h3 class="text-2xl font-bold text-gray-800 mb-4">Your User ID QR Code</h3><div id="qr-code-container" class="flex justify-center mb-6"></div><button id="close-qr-modal-btn" class="w-full bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 transition">Close</button></div>
            </div>
            <div id="qr-scanner-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
                <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-md"><h3 class="text-2xl font-bold text-center text-gray-800 mb-4">Scan QR Code</h3><div id="qr-reader" style="width: 100%;"></div><button id="close-scanner-modal-btn" class="mt-6 w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition">Cancel</button></div>
            </div>
        </div>
        
        <!-- Video Call UI -->
        <div id="video-call-container" class="fixed inset-0 bg-gray-900 z-40 hidden flex-col items-center justify-center">
            <div id="audio-call-avatar-container" class="hidden absolute inset-0 items-center justify-center">
                <div class="w-40 h-40 rounded-full bg-gray-700 flex items-center justify-center">
                    <span id="audio-call-avatar-initial" class="text-6xl font-bold text-white"></span>
                </div>
            </div>
            <video id="remote-video" autoplay playsinline class="w-full h-full object-cover"></video>
            <video id="local-video" autoplay playsinline muted class="absolute w-1/4 max-w-xs bottom-24 md:bottom-4 right-4 rounded-lg border-2 border-white"></video>
            
            <div id="call-status" class="absolute top-4 left-1/2 -translate-x-1/2 bg-black bg-opacity-50 text-white px-4 py-2 rounded-lg">Connecting...</div>

            <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-4 p-4 bg-black bg-opacity-25 rounded-full">
                <button id="toggle-mic-btn" class="p-3 bg-gray-500 rounded-full text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg></button>
                <button id="toggle-cam-btn" class="p-3 bg-gray-500 rounded-full text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button>
                <button id="hang-up-btn" class="p-3 bg-red-600 rounded-full text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8l2-2m0 0l2 2m-2-2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h4.586a1 1 0 01.707.293l2 2z"></path></svg></button>
            </div>
        </div>

        <!-- Main Chat Interface -->
        <div class="flex h-full w-full hidden relative overflow-hidden" id="main-chat-interface">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-full h-screen bg-white border-r border-gray-200 flex flex-col md:w-1/3 lg:w-1/4 md:relative">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex justify-between items-start">
                        <h1 class="text-2xl font-bold text-blue-600">Vrindopnishad</h1>
                        <button id="logout-btn" class="text-sm font-semibold text-red-500 hover:text-red-700">Logout</button>
                    </div>
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-600">Your User ID:</p>
                                <p id="current-user-id" class="text-xs text-gray-800 font-mono break-all cursor-pointer" title="Click to copy"></p>
                            </div>
                            <button id="show-qr-btn" title="Show my QR Code"><svg class="w-6 h-6 text-gray-600 hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 5h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></button>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-b border-gray-200">
                    <input type="text" id="search-users-input" placeholder="Search new user by name or ID..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="scan-qr-btn" class="mt-3 w-full flex items-center justify-center bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 5h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>Scan QR Code</button>
                </div>

                <div class="flex-grow overflow-y-auto">
                    <!-- AI Assistant & Recent Chats -->
                    <div class="p-4">
                        <div id="ai-assistant-entry" class="space-y-2"></div>
                        <h3 class="text-lg font-semibold text-gray-800 my-2">Recent Chats</h3>
                        <div id="recent-chats-list" class="space-y-2">
                             <p id="no-recents-message" class="text-gray-500 text-sm p-2">No recent conversations.</p>
                        </div>
                    </div>
                     <!-- Search Results List -->
                    <div id="search-results-container" class="p-4 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Search Results</h3>
                        <div id="search-results-list" class="space-y-2"></div>
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <main id="chat-area" class="w-full h-screen flex-col bg-gray-50 md:w-2/3 lg:w-3/4">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center p-4">
                    <svg class="w-24 h-24 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2s10 4.477 10 10z"></path></svg>
                    <h2 class="text-2xl font-semibold text-gray-700">Welcome, <span id="welcome-user-name"></span>!</h2>
                    <p class="text-gray-500 mt-2">Select a recent chat or search for a new user to begin.</p>
                </div>
                <div id="chat-container" class="hidden flex-col h-screen">
                    <!-- Chat Header -->
                    <header class="bg-white p-4 border-b border-gray-200 flex items-center justify-between">
                        <div class="flex items-center min-w-0">
                             <button id="back-to-sidebar-btn" class="mr-3 p-2 rounded-full hover:bg-gray-100 md:hidden">
                                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            </button>
                            <div id="chat-header-avatar" class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xl mr-3 flex-shrink-0"></div>
                            <div class="overflow-hidden">
                                <h3 id="chat-header-name" class="font-semibold text-gray-800 truncate"></h3>
                                <p id="chat-header-role" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                             <button id="audio-call-btn" title="Start audio call" class="hidden p-2 rounded-full hover:bg-gray-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            </button>
                            <button id="video-call-btn" title="Start video call" class="hidden p-2 rounded-full hover:bg-gray-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                            <button id="delete-chat-btn" title="Delete this conversation" class="hidden p-2 rounded-full hover:bg-red-100">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </header>

                    <!-- Messages -->
                    <div id="chat-messages" class="flex-1 p-6 overflow-y-auto"></div>

                    <!-- Message Input -->
                    <footer class="p-4 bg-white border-t border-gray-200">
                        <div id="ai-suggestion-bar" class="hidden justify-center mb-2">
                             <button id="get-suggestions-btn" class="bg-purple-100 text-purple-700 text-sm font-semibold px-4 py-2 rounded-full hover:bg-purple-200 transition">✨ Get Suggestions</button>
                        </div>
                        <form id="message-form" class="flex items-center space-x-3">
                            <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" class="w-full py-2 px-4 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" id="polish-btn" title="Polish message with AI" class="p-2 rounded-full hover:bg-gray-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                            </button>
                            <button type="submit" class="bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 transition flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </button>
                        </form>
                    </footer>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy, getDoc, getDocs, writeBatch, deleteDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyBjy-y-NvsG6JGUc_GHqinuO4zydJ7NVU4",
          authDomain: "vrinda-chat.firebaseapp.com",
          projectId: "vrinda-chat",
          storageBucket: "vrinda-chat.firebasestorage.app",
          messagingSenderId: "644051269513",
          appId: "1:644051269513:web:5934afc082be418eec5358",
          measurementId: "G-DBZ0LMJW0G"
        };
        const appId = firebaseConfig.projectId;
        const CHATBOT_ID = 'vrinda-ai-bot';
        let db, auth;
        let appUserId = null; 
        let currentUserProfile = null;
        let activeChatPartner = null;
        let unsubscribeMessages = null;
        let allMessages = [];
        let html5QrCode = null;
        let isChatbotActive = false;
        let chatbotHistory = [];

        // WebRTC Globals
        let peerConnection;
        let localStream;
        let remoteStream;
        let callDocUnsubscribe = null;
        let userProfileUnsubscribe = null;
        let currentCallInfo = null;
        let currentCallType = null;
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] },
            ],
            iceCandidatePoolSize: 10,
        };

        // --- DOM ELEMENTS ---
        const audioCallBtn = document.getElementById('audio-call-btn');
        const callTypeText = document.getElementById('call-type-text');
        const audioCallAvatarContainer = document.getElementById('audio-call-avatar-container');
        const audioCallAvatarInitial = document.getElementById('audio-call-avatar-initial');
        const videoCallContainer = document.getElementById('video-call-container');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const callStatus = document.getElementById('call-status');
        const toggleMicBtn = document.getElementById('toggle-mic-btn');
        const toggleCamBtn = document.getElementById('toggle-cam-btn');
        const hangUpBtn = document.getElementById('hang-up-btn');
        const incomingCallModal = document.getElementById('incoming-call-modal');
        const callerName = document.getElementById('caller-name');
        const acceptCallBtn = document.getElementById('accept-call-btn');
        const declineCallBtn = document.getElementById('decline-call-btn');
        const videoCallBtn = document.getElementById('video-call-btn');
        const backToSidebarBtn = document.getElementById('back-to-sidebar-btn');
        const loadingScreen = document.getElementById('loading-screen');
        const loader = document.getElementById('loader');
        const authModal = document.getElementById('auth-modal');
        const mainChatInterface = document.getElementById('main-chat-interface');
        const aiAssistantEntry = document.getElementById('ai-assistant-entry');
        const aiSuggestionBar = document.getElementById('ai-suggestion-bar');
        const getSuggestionsBtn = document.getElementById('get-suggestions-btn');
        const polishBtn = document.getElementById('polish-btn');
        const aiSuggestionModal = document.getElementById('ai-suggestion-modal');
        const suggestionList = document.getElementById('suggestion-list');
        const closeSuggestionModal = document.getElementById('close-suggestion-modal');
        const aiPolishModal = document.getElementById('ai-polish-modal');
        const polishedTextContainer = document.getElementById('polished-text-container');
        const cancelPolish = document.getElementById('cancel-polish');
        const usePolishedText = document.getElementById('use-polished-text');
        const loginTab = document.getElementById('login-tab');
        const signupTab = document.getElementById('signup-tab');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');
        const logoutBtn = document.getElementById('logout-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const googleSignUpBtn = document.getElementById('google-signup-btn');
        const currentUserIdElem = document.getElementById('current-user-id');
        const welcomeUserName = document.getElementById('welcome-user-name');
        const recentChatsList = document.getElementById('recent-chats-list');
        const noRecentsMessage = document.getElementById('no-recents-message');
        const searchUsersInput = document.getElementById('search-users-input');
        const searchResultsContainer = document.getElementById('search-results-container');
        const searchResultsList = document.getElementById('search-results-list');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatContainer = document.getElementById('chat-container');
        const chatHeaderName = document.getElementById('chat-header-name');
        const chatHeaderRole = document.getElementById('chat-header-role');
        const chatHeaderAvatar = document.getElementById('chat-header-avatar');
        const deleteChatBtn = document.getElementById('delete-chat-btn');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const showQrBtn = document.getElementById('show-qr-btn');
        const qrCodeModal = document.getElementById('qr-code-modal');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const closeQrModalBtn = document.getElementById('close-qr-modal-btn');
        const scanQrBtn = document.getElementById('scan-qr-btn');
        const qrScannerModal = document.getElementById('qr-scanner-modal');
        const closeScannerModalBtn = document.getElementById('close-scanner-modal-btn');

        // --- INITIALIZATION ---
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuthListener();
                setupAuthForms();
                setupAIFeatureListeners();
                setupMobileNav();
                setupCallControls();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }

        function setupMobileNav() {
            backToSidebarBtn.addEventListener('click', () => {
                mainChatInterface.classList.remove('chat-view-active');
            });
        }

        // --- AUTH & PROFILE MANAGEMENT ---
        function setupAuthListener() {
             onAuthStateChanged(auth, async (user) => {
                if (userProfileUnsubscribe) userProfileUnsubscribe();

                const params = new URLSearchParams(window.location.search);
                const urlUid = params.get('uid');

                if (user) {
                    if (user.isAnonymous && urlUid) {
                        appUserId = urlUid;
                        await setupSession(appUserId, params.get('name'), params.get('role'));
                    } else if (!user.isAnonymous) {
                        appUserId = user.uid;
                        const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/${appUserId}`);
                        // Set up a listener that waits for the profile to be created
                        userProfileUnsubscribe = onSnapshot(userDocRef, (userDoc) => {
                            if (userDoc.exists()) {
                                const profile = userDoc.data();
                                // Only set up the session if it's a new user or a different user
                                if (!currentUserProfile || currentUserProfile.uid !== profile.uid) {
                                    setupSession(profile.uid, profile.displayName, profile.role);
                                }
                            }
                        });
                    } else {
                         // This case handles anonymous users who somehow get here without URL params
                         signOut(auth);
                    }
                } else {
                    // No user signed in
                    appUserId = null;
                    currentUserProfile = null;
                    if (urlUid) {
                        // Integrated mode, needs to sign in anonymously to proceed
                        signInAnonymously(auth).catch(err => console.error("Anonymous sign in failed", err));
                    } else {
                        // Standard mode, show the login/signup form
                        loader.classList.add('hidden');
                        authModal.classList.remove('hidden');
                    }
                }
            });
        }
        
        async function setupSession(uid, name, role) {
            currentUserProfile = { uid, displayName: name, role };
            const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/${uid}`);
            await setDoc(userDocRef, currentUserProfile, { merge: true }); // Ensure profile is up-to-date
            
            // If the UI is not yet visible, show it now
            if (mainChatInterface.classList.contains('hidden')) {
                loadingScreen.classList.add('hidden');
                mainChatInterface.classList.remove('hidden');
            }

            currentUserIdElem.textContent = uid;
            welcomeUserName.textContent = name.split(' ')[0];
            renderSidebar();
            listenForIncomingCalls();
        }
        
        // --- AUTH FORMS ---
        function setupAuthForms() {
             loginTab.addEventListener('click', () => {
                loginTab.classList.add('bg-gray-100', 'border-blue-600');
                loginTab.classList.remove('text-gray-500');
                signupTab.classList.remove('bg-gray-100', 'border-blue-600');
                signupTab.classList.add('text-gray-500');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            });
            signupTab.addEventListener('click', () => {
                signupTab.classList.add('bg-gray-100', 'border-blue-600');
                signupTab.classList.remove('text-gray-500');
                loginTab.classList.remove('bg-gray-100', 'border-blue-600');
                loginTab.classList.add('text-gray-500');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            });
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginError.textContent = '';
                try {
                    await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value);
                } catch (error) {
                    loginError.textContent = error.message;
                }
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                signupError.textContent = '';
                try {
                    const { user } = await createUserWithEmailAndPassword(auth, signupForm['signup-email'].value, signupForm['signup-password'].value);
                    const userProfile = { uid: user.uid, displayName: signupForm['signup-name'].value, role: signupForm['signup-role'].value };
                    await setDoc(doc(db, `/artifacts/${appId}/public/data/users/${user.uid}`), userProfile);
                } catch (error) {
                    signupError.textContent = error.message;
                }
            });
            
            const handleGoogleAuth = async () => {
                loginError.textContent = '';
                signupError.textContent = '';
                const provider = new GoogleAuthProvider();
                try {
                    const { user } = await signInWithPopup(auth, provider);
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/${user.uid}`);
                    const userDoc = await getDoc(userDocRef);
                    if (!userDoc.exists()) {
                        const newUserProfile = { uid: user.uid, displayName: user.displayName, role: 'Customer' };
                        await setDoc(userDocRef, newUserProfile);
                    }
                } catch (error) {
                    const errorMessage = `Google Auth Error: ${error.message}`;
                    loginError.textContent = errorMessage;
                    signupError.textContent = errorMessage;
                }
            };
            
            googleLoginBtn.addEventListener('click', handleGoogleAuth);
            googleSignUpBtn.addEventListener('click', handleGoogleAuth);

            logoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.reload()));
        }
        
        // --- UI & CHAT LISTING ---
        function renderSidebar() {
            renderChatbotEntry();
            listenForRecentChats();
        }

        function renderChatbotEntry() {
            aiAssistantEntry.innerHTML = '';
            const chatbot = { uid: CHATBOT_ID, displayName: 'Vrinda AI Assistant', role: 'AI' };
            renderUserInList(chatbot, aiAssistantEntry, true);
        }

        function listenForRecentChats() {
            const recentsRef = collection(db, `/artifacts/${appId}/public/data/users/${appUserId}/recents`);
            onSnapshot(query(recentsRef, orderBy('lastMessageTimestamp', 'desc')), (snapshot) => {
                recentChatsList.innerHTML = '';
                if (snapshot.empty) {
                    noRecentsMessage.classList.remove('hidden');
                } else {
                    noRecentsMessage.classList.add('hidden');
                    snapshot.forEach(doc => renderUserInList(doc.data(), recentChatsList, false));
                }
            });
        }

        function renderUserInList(user, listElement, isBot) {
            const userElement = document.createElement('div');
            userElement.className = 'flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-100';
            userElement.addEventListener('click', () => startChat(user));
            
            let avatarColor = isBot ? 'bg-purple-500' : (user.role === 'Employee' ? 'bg-blue-500' : 'bg-green-500');
            const avatar = document.createElement('div');
            avatar.className = `w-10 h-10 rounded-full text-white flex-shrink-0 flex items-center justify-center font-bold mr-3 ${avatarColor}`;
            avatar.innerHTML = isBot ? `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>` : user.displayName.charAt(0).toUpperCase();
            const userInfo = document.createElement('div');
            userInfo.innerHTML = `<p class="font-semibold text-gray-800">${user.displayName}</p>`;
            userElement.append(avatar, userInfo);
            listElement.appendChild(userElement);
        }

        // --- SEARCH ---
        let searchTimeout;
        searchUsersInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const searchTerm = e.target.value.trim().toLowerCase();
            if (searchTerm.length < 2) {
                searchResultsContainer.classList.add('hidden');
                return;
            }
            searchTimeout = setTimeout(() => performSearch(searchTerm), 300);
        });

        async function performSearch(searchTerm) {
            searchResultsList.innerHTML = '<p class="text-gray-500 text-sm p-2">Searching...</p>';
            searchResultsContainer.classList.remove('hidden');
            try {
                const snapshot = await getDocs(collection(db, `/artifacts/${appId}/public/data/users`));
                const results = snapshot.docs.map(doc => doc.data()).filter(user => user.uid !== appUserId && (user.displayName.toLowerCase().includes(searchTerm) || user.uid.toLowerCase() === searchTerm));
                searchResultsList.innerHTML = results.length === 0 ? '<p class="text-gray-500 text-sm p-2">No users found.</p>' : '';
                results.forEach(user => renderUserInList(user, searchResultsList, false));
            } catch (error) {
                console.error("Error searching users:", error);
                searchResultsList.innerHTML = '<p class="text-red-500 text-sm p-2">Search failed.</p>';
            }
        }

        // --- CHAT FUNCTIONALITY ---
        function startChat(otherUser) {
            mainChatInterface.classList.add('chat-view-active');
            isChatbotActive = (otherUser.uid === CHATBOT_ID);
            activeChatPartner = isChatbotActive ? null : otherUser;
            
            welcomeScreen.classList.add('hidden');
            searchResultsContainer.classList.add('hidden');
            searchUsersInput.value = '';
            chatContainer.classList.remove('hidden');
            chatContainer.classList.add('flex');

            chatHeaderName.textContent = otherUser.displayName;
            chatHeaderRole.textContent = otherUser.role;
            let avatarColor = isChatbotActive ? 'bg-purple-500' : (otherUser.role === 'Employee' ? 'bg-blue-500' : 'bg-green-500');
            chatHeaderAvatar.className = `w-10 h-10 rounded-full text-white flex items-center justify-center font-bold text-xl mr-3 flex-shrink-0 ${avatarColor}`;
            chatHeaderAvatar.innerHTML = isChatbotActive ? `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>` : otherUser.displayName.charAt(0).toUpperCase();
            
            aiSuggestionBar.classList.toggle('hidden', isChatbotActive || currentUserProfile.role !== 'Employee' || otherUser.role !== 'Customer');
            deleteChatBtn.classList.toggle('hidden', isChatbotActive || currentUserProfile.role !== 'Employee');
            videoCallBtn.classList.toggle('hidden', isChatbotActive);
            audioCallBtn.classList.toggle('hidden', isChatbotActive);

            if (unsubscribeMessages) unsubscribeMessages();
            chatMessages.innerHTML = '';
            allMessages = [];

            if (isChatbotActive) {
                renderMessage({ text: 'Hello! I am Vrinda, your AI assistant. How can I help you today?', senderId: CHATBOT_ID });
                chatbotHistory = [];
            } else {
                const chatId = [appUserId, otherUser.uid].sort().join('_');
                const messagesRef = collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`);
                unsubscribeMessages = onSnapshot(query(messagesRef, orderBy('timestamp')), (snapshot) => {
                    chatMessages.innerHTML = '';
                    allMessages = snapshot.docs.map(doc => doc.data());
                    allMessages.forEach(msg => renderMessage(msg));
                    scrollToBottom();
                });
            }
        }
        
        function renderMessage(message, isTyping = false) {
            const isSender = message.senderId === appUserId;
            const isBot = message.senderId === CHATBOT_ID;
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex mb-4 ${isSender ? 'justify-end' : 'justify-start'}`;
            let bubbleContent = isTyping ? `<div class="typing-indicator"><span></span><span></span><span></span></div>` : formatAIResponse(message.text);
            let bubbleColor = isSender ? 'bg-blue-600 text-white' : (isBot ? 'bg-purple-100 text-purple-900' : 'bg-white text-gray-800');
            messageWrapper.innerHTML = `<div class="max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ${bubbleColor}">${bubbleContent}</div>`;
            if (isTyping) messageWrapper.id = 'typing-indicator';
            chatMessages.appendChild(messageWrapper);
            scrollToBottom();
        }

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;
            messageInput.value = '';
            if (isChatbotActive) await handleChatbotMessage(text);
            else if (activeChatPartner) {
                const chatId = [appUserId, activeChatPartner.uid].sort().join('_');
                try {
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`), { text, senderId: appUserId, timestamp: serverTimestamp() });
                    await updateRecents(activeChatPartner);
                } catch (error) { console.error("Error sending message:", error); }
            }
        });

        // --- VIDEO & AUDIO CALL (WebRTC) ---
        function setupCallControls() {
            videoCallBtn.addEventListener('click', () => initiateCall('video'));
            audioCallBtn.addEventListener('click', () => initiateCall('audio'));
            hangUpBtn.addEventListener('click', hangUp);
            toggleMicBtn.addEventListener('click', toggleMic);
            toggleCamBtn.addEventListener('click', toggleCam);
        }

        async function initiateCall(callType) {
            if (!activeChatPartner) return;
            
            const callDocRef = doc(db, `/artifacts/${appId}/public/data/users/${activeChatPartner.uid}/calls/${appUserId}`);
            currentCallInfo = { calleeId: activeChatPartner.uid, callerId: appUserId };
            currentCallType = callType;

            peerConnection = new RTCPeerConnection(servers);
            registerPeerConnectionListeners('caller');
            
            const constraints = callType === 'video' ? { video: true, audio: true } : { video: false, audio: true };
            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (error) {
                console.error("Error accessing media devices.", error);
                alert("Could not start call. Please grant camera and/or microphone permissions in your browser settings and try again.");
                return;
            }

            remoteStream = new MediaStream();

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            localVideo.srcObject = localStream;
            remoteVideo.srcObject = remoteStream;

            const offerDescription = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offerDescription);

            const offer = { sdp: offerDescription.sdp, type: offerDescription.type };
            await setDoc(callDocRef, { offer, callerProfile: currentUserProfile, status: 'ringing', type: callType });

            callDocUnsubscribe = onSnapshot(callDocRef, async (snapshot) => {
                const data = snapshot.data();
                if (!peerConnection.currentRemoteDescription && data?.answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
                if (data?.status === 'declined' || data?.status === 'ended') {
                    hangUp();
                }
            });
            
            setupCallUI(callType, activeChatPartner.displayName);
            callStatus.textContent = `Calling ${activeChatPartner.displayName}...`;
        }

        function listenForIncomingCalls() {
            if (!appUserId) return;
            const callsRef = collection(db, `/artifacts/${appId}/public/data/users/${appUserId}/calls`);
            const q = query(callsRef, where('status', '==', 'ringing'));

            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const callData = change.doc.data();
                        const callerId = change.doc.id;
                        
                        callerName.textContent = callData.callerProfile.displayName;
                        callTypeText.textContent = callData.type;
                        incomingCallModal.classList.remove('hidden');

                        acceptCallBtn.onclick = async () => {
                            incomingCallModal.classList.add('hidden');
                            await answerCall(callerId, callData.offer, callData.type, callData.callerProfile);
                        };
                        declineCallBtn.onclick = async () => {
                            incomingCallModal.classList.add('hidden');
                            const callDocRef = doc(db, `/artifacts/${appId}/public/data/users/${appUserId}/calls/${callerId}`);
                            await setDoc(callDocRef, { status: 'declined' }, { merge: true });
                        };
                    }
                });
            });
        }
        
        async function answerCall(callerId, offer, callType, callerProfile) {
            currentCallInfo = { calleeId: appUserId, callerId: callerId, callerProfile };
            currentCallType = callType;
            const callDocRef = doc(db, `/artifacts/${appId}/public/data/users/${appUserId}/calls/${callerId}`);
            
            peerConnection = new RTCPeerConnection(servers);
            registerPeerConnectionListeners('callee');

            const constraints = callType === 'video' ? { video: true, audio: true } : { video: false, audio: true };
            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (error) {
                console.error("Error accessing media devices.", error);
                alert("Could not answer call. Please grant camera and/or microphone permissions in your browser settings.");
                await setDoc(callDocRef, { status: 'declined' }, { merge: true });
                return;
            }

            remoteStream = new MediaStream();

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            localVideo.srcObject = localStream;
            remoteVideo.srcObject = remoteStream;

            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answerDescription = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answerDescription);

            const answer = { type: answerDescription.type, sdp: answerDescription.sdp };
            await setDoc(callDocRef, { answer, status: 'active' }, { merge: true });
            
            setupCallUI(callType, callerProfile.displayName);
        }

        function setupCallUI(callType, remoteUserName) {
            const isVideoCall = callType === 'video';
            videoCallContainer.classList.remove('hidden');
            videoCallContainer.classList.add('flex');
            
            localVideo.classList.toggle('hidden', !isVideoCall);
            remoteVideo.classList.toggle('hidden', !isVideoCall);
            toggleCamBtn.classList.toggle('hidden', !isVideoCall);

            audioCallAvatarContainer.classList.toggle('hidden', isVideoCall);
            audioCallAvatarContainer.classList.toggle('flex', !isVideoCall);
            audioCallAvatarInitial.textContent = remoteUserName.charAt(0).toUpperCase();
        }

        function registerPeerConnectionListeners(role) {
            const {calleeId, callerId} = currentCallInfo;
            const callDocRef = doc(db, `/artifacts/${appId}/public/data/users/${calleeId}/calls/${callerId}`);

            const myCandidatesCollection = role === 'caller' ? collection(callDocRef, 'callerCandidates') : collection(callDocRef, 'calleeCandidates');
            const theirCandidatesCollection = role === 'caller' ? collection(callDocRef, 'calleeCandidates') : collection(callDocRef, 'callerCandidates');

            peerConnection.onicecandidate = event => {
                if (event.candidate) addDoc(myCandidatesCollection, event.candidate.toJSON());
            };

            onSnapshot(theirCandidatesCollection, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });

            peerConnection.ontrack = event => {
                event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
            };

            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') callStatus.textContent = "Connected";
                if (['disconnected', 'failed', 'closed'].includes(peerConnection.connectionState)) hangUp();
            };
        }

        async function hangUp() {
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (peerConnection) peerConnection.close();
            
            videoCallContainer.classList.add('hidden');
            audioCallAvatarContainer.classList.add('hidden');
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            peerConnection = null;

            if (callDocUnsubscribe) callDocUnsubscribe();
            
            if (currentCallInfo) {
                const callDocRef = doc(db, `/artifacts/${appId}/public/data/users/${currentCallInfo.calleeId}/calls/${currentCallInfo.callerId}`);
                const callDocSnap = await getDoc(callDocRef);
                if(callDocSnap.exists() && callDocSnap.data().status !== 'ended') {
                    await setDoc(callDocRef, { status: 'ended' }, { merge: true });
                    
                    setTimeout(async () => {
                         // Final cleanup after a few seconds
                        const callerCandidates = await getDocs(collection(callDocRef, 'callerCandidates'));
                        callerCandidates.forEach(c => deleteDoc(c.ref));
                        const calleeCandidates = await getDocs(collection(callDocRef, 'calleeCandidates'));
                        calleeCandidates.forEach(c => deleteDoc(c.ref));
                        await deleteDoc(callDocRef);
                    }, 5000);
                }
            }
            currentCallInfo = null;
            currentCallType = null;
        }

        function toggleMic() {
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !track.enabled;
                toggleMicBtn.classList.toggle('bg-red-500', !track.enabled);
                toggleMicBtn.classList.toggle('bg-gray-500', track.enabled);
            });
        }
        
        function toggleCam() {
            localStream.getVideoTracks().forEach(track => {
                track.enabled = !track.enabled;
                toggleCamBtn.classList.toggle('bg-red-500', !track.enabled);
                toggleCamBtn.classList.toggle('bg-gray-500', track.enabled);
            });
        }

        // --- AI FEATURES (GEMINI API) ---
        function setupAIFeatureListeners() {
            getSuggestionsBtn.addEventListener('click', getSmartReplies);
            polishBtn.addEventListener('click', polishMessage);
            closeSuggestionModal.addEventListener('click', () => aiSuggestionModal.classList.add('hidden'));
            cancelPolish.addEventListener('click', () => aiPolishModal.classList.add('hidden'));
            usePolishedText.addEventListener('click', () => {
                messageInput.value = polishedTextContainer.textContent;
                aiPolishModal.classList.add('hidden');
            });
        }
        
        async function callGemini(payload) {
             const apiKey = "AIzaSyBB7W-dCdNUWvMlaYeviMNFsoXK5sdZOMw";
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
             try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                return await response.json();
             } catch (error) {
                console.error("Gemini API Error:", error);
                alert("An error occurred while contacting the AI. Please try again.");
                return null;
             }
        }
        async function getSmartReplies() {
            if (!activeChatPartner || allMessages.length === 0) return;
            const lastMessage = allMessages.filter(m => m.senderId === activeChatPartner.uid).pop();
            if (!lastMessage) return alert("Waiting for customer's message to suggest a reply.");
            suggestionList.innerHTML = '<p class="text-gray-500">✨ Generating suggestions...</p>';
            aiSuggestionModal.classList.remove('hidden');
            const payload = {
                contents: [{ parts: [{ text: `A customer said: "${lastMessage.text}". Generate three brief, professional, and helpful replies.` }] }],
                generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "reply": { "type": "STRING" }}}}}
            };
            const result = await callGemini(payload);
            const suggestions = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (suggestions) {
                suggestionList.innerHTML = '';
                JSON.parse(suggestions).forEach(item => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-3 bg-gray-100 rounded-lg hover:bg-blue-100 transition';
                    button.textContent = item.reply;
                    button.onclick = () => { messageInput.value = item.reply; aiSuggestionModal.classList.add('hidden'); };
                    suggestionList.appendChild(button);
                });
            } else {
                 suggestionList.innerHTML = '<p class="text-red-500">Could not generate suggestions.</p>';
            }
        }
        async function polishMessage() {
            const originalText = messageInput.value.trim();
            if (!originalText) return;
            polishedTextContainer.innerHTML = '<p class="text-gray-500">✨ Polishing message...</p>';
            aiPolishModal.classList.remove('hidden');
            const payload = { contents: [{ parts: [{ text: `Rephrase the following text to be more professional and clear: "${originalText}"` }] }] };
            const result = await callGemini(payload);
            const polishedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            polishedTextContainer.innerHTML = formatAIResponse(polishedText || "Could not polish the message.");
        }

        function formatAIResponse(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italic
                .split('\n')                              // Split by newlines
                .map(line => line.trim())                 // Trim whitespace
                .filter(line => line.length > 0)          // Remove empty lines
                .map(line => `<p class="mb-2">${line}</p>`) // Wrap each line in a paragraph
                .join('');                                // Join back together
        }

        async function handleChatbotMessage(userMessage) {
            renderMessage({ text: userMessage, senderId: appUserId });
            renderMessage({ senderId: CHATBOT_ID }, true);
            chatbotHistory.push({ role: "user", parts: [{ text: userMessage }] });
            const systemPrompt = `You are Vrinda, a friendly AI assistant for Vrindopnishad. Your goal is to answer questions about the company and its projects.
            - **About Vrindopnishad:** An innovative tech company in India specializing in sustainable technology and smart infrastructure. We also have 'Vrinda Pictures', selling high-quality digital images of Lord Krishna.
            - **Projects:** 'GreenCity OS' (smart city management), 'AquaPure' (solar water purification), 'Agri-Sphere' (AI for farming), and 'Vrinda Pictures'.
            - **Persona:** Be welcoming, clear, and concise. Only answer questions related to Vrindopnishad. Format responses with markdown (e.g., **bold text**).`;
            const payload = { contents: chatbotHistory, systemInstruction: { parts: [{ text: systemPrompt }] } };
            const result = await callGemini(payload);
            const botResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            document.getElementById('typing-indicator')?.remove();
            if (botResponse) {
                chatbotHistory.push({ role: "model", parts: [{ text: botResponse }] });
                renderMessage({ text: botResponse, senderId: CHATBOT_ID });
            } else {
                renderMessage({ text: "Sorry, I couldn't generate a response. Please try again.", senderId: CHATBOT_ID });
            }
        }
        
        // --- REST OF THE FUNCTIONS (Unchanged) ---
        async function updateRecents(otherUser) {
            const timestamp = serverTimestamp();
            const myRecentRef = doc(db, `/artifacts/${appId}/public/data/users/${appUserId}/recents/${otherUser.uid}`);
            const otherRecentRef = doc(db, `/artifacts/${appId}/public/data/users/${otherUser.uid}/recents/${appUserId}`);
            const batch = writeBatch(db);
            batch.set(myRecentRef, { ...otherUser, lastMessageTimestamp: timestamp });
            batch.set(otherRecentRef, { ...currentUserProfile, lastMessageTimestamp: timestamp });
            await batch.commit();
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        deleteChatBtn.addEventListener('click', () => { if (activeChatPartner) confirmDeleteModal.classList.remove('hidden'); });
        cancelDeleteBtn.addEventListener('click', () => confirmDeleteModal.classList.add('hidden'));
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!activeChatPartner || currentUserProfile.role !== 'Employee') return;
            const otherUserUid = activeChatPartner.uid;
            const chatId = [appUserId, otherUserUid].sort().join('_');
            const messagesRef = collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`);
            const messagesSnapshot = await getDocs(messagesRef);
            const batch = writeBatch(db);
            messagesSnapshot.forEach(doc => batch.delete(doc.ref));
            batch.delete(doc(db, `/artifacts/${appId}/public/data/users/${appUserId}/recents/${otherUserUid}`));
            batch.delete(doc(db, `/artifacts/${appId}/public/data/users/${otherUserUid}/recents/${appUserId}`));
            await batch.commit();
            activeChatPartner = null;
            if (unsubscribeMessages) unsubscribeMessages();
            chatContainer.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            confirmDeleteModal.classList.add('hidden');
        });

        currentUserIdElem.addEventListener('click', () => navigator.clipboard.writeText(appUserId));
        showQrBtn.addEventListener('click', () => {
            qrCodeContainer.innerHTML = '';
            const qr = qrcode(0, 'L');
            qr.addData(appUserId);
            qr.make();
            qrCodeContainer.innerHTML = qr.createImgTag(6, 8);
            qrCodeModal.classList.remove('hidden');
        });
        
        closeQrModalBtn.addEventListener('click', () => qrCodeModal.classList.add('hidden'));

        scanQrBtn.addEventListener('click', () => {
            qrScannerModal.classList.remove('hidden');
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, async (decodedText) => {
                await stopScanner();
                try {
                    const userDoc = await getDoc(doc(db, `/artifacts/${appId}/public/data/users/${decodedText}`));
                    if (userDoc.exists()) startChat(userDoc.data());
                    else alert('User not found.');
                } catch (error) { alert('Could not process QR code.'); }
            }).catch(err => console.log(`QR Scan Error: ${err}`));
        });

        async function stopScanner() {
            if (html5QrCode?.isScanning) { try { await html5QrCode.stop(); } catch (err) {} }
            html5QrCode = null;
            qrScannerModal.classList.add('hidden');
        }
        
        closeScannerModalBtn.addEventListener('click', stopScanner);
        
        // --- START THE APP ---
        window.onload = initialize;
    </script>
</body>
</html>