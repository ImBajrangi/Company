<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vrindopnishad Login</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        /* Custom style for Google icon */
        .google-icon {
            width: 18px;
            height: 18px;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>

    <!-- Main Container - Reduced size for focus on Auth -->
    <div id="app-container" class="w-full max-w-md bg-white shadow-2xl rounded-xl p-8 space-y-6">

        <!-- Header -->
        <header class="text-center space-y-2">
            <h1 class="text-3xl font-extrabold text-gray-900">Vrindopnishad Login</h1>
            <p class="text-gray-500">Sign in or sign up to continue.</p>
        </header>

        <!-- Main Authentication Section -->
        <div class="p-6 border border-gray-200 rounded-lg shadow-inner bg-gray-50 flex flex-col items-center space-y-6">
            <h2 class="text-xl font-bold text-indigo-700 w-full text-center" id="auth-title"></h2>

            <!-- Loading/Setup State -->
            <div id="loading-state" class="text-center py-6 w-full">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full"></div>
                <p class="mt-4 text-gray-600">Initializing Authentication services...</p>
            </div>

            <!-- Auth Form & Buttons (Logged Out State) -->
            <div id="auth-container" class="space-y-4 hidden w-full">
                
                <!-- Email/Password Form -->
                <form id="auth-form" class="space-y-3">
                    
                    <!-- New: Display Name Field (Visible only during Sign Up) -->
                    <div id="name-field-container" class="hidden">
                        <label for="display-name" class="block text-sm font-medium text-gray-700">Display Name</label>
                        <input type="text" id="display-name" autocomplete="name"
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="Shri Radhe">
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="email" required autocomplete="email"
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" required autocomplete="current-password"
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" id="submit-btn"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-grey-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Sign In
                    </button>
                </form>

                <!-- Toggle Mode Button -->
                <p class="text-center text-sm">
                    <span class="text-gray-600" id="toggle-prompt">Don't have an account?</span>
                    <button id="toggle-auth-btn"
                        class="font-medium text-indigo-600 hover:text-indigo-500 transition duration-150 ease-in-out">
                        Sign Up
                    </button>
                </p>

                <div class="relative flex items-center justify-center my-4">
                    <div class="w-full border-t border-gray-300"></div>
                    <span class="absolute px-3 bg-gray-50 text-gray-500 text-sm font-medium">OR</span>
                </div>

                <!-- Google Sign-In Button (FIXED LOGO) -->
                <button id="google-signin-btn"
                    class="w-full flex items-center justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    <!-- Updated and simplified Google Logo SVG -->
                    <svg class="google-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                        <!-- Blue -->
                        <path fill="#4285F4" d="M386.9,235.8c0-14.8-1.3-29.2-3.8-43.2H256v82.7h72.4c-3.1,17.2-12.1,31.7-25.7,41.9v53.3h68.8C421.1,380.2,453.7,314.1,453.7,256C453.7,247.9,453.1,241.2,452.4,235.8z"/>
                        <!-- Red -->
                        <path fill="#EA4335" d="M256,453.7c33.5,0,62.8-11.3,83.7-30.7l-68.8-53.3c-18.7,12.5-43,20-68.8,20c-53.3,0-98.3-35.8-114.6-84.5h-71.1v55.5C70.6,400.9,157.9,453.7,256,453.7z"/>
                        <!-- Yellow -->
                        <path fill="#FBBC05" d="M141.4,279.7c-3.6-10.4-5.6-21.5-5.6-32.9s2-22.5,5.6-32.9v-55.5h-71.1C58.3,191.6,50.7,222.9,50.7,246.8s7.6,55.2,19.6,83.9L141.4,279.7z"/>
                        <!-- Green -->
                        <path fill="#34A853" d="M256,158c28.8,0,54.7,9.9,75.1,29.3L400,111.4c-20.9-19.4-50.2-30.7-83.7-30.7c-98.1,0-185.4,52.8-232.7,129.9l71.1,55.5C157.7,193.8,202.7,158,256,158z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>

            <!-- User Profile (Logged In State) -->
            <div id="profile-container" class="space-y-6 text-center hidden w-full">
                <p class="text-lg text-gray-700 font-semibold">Logged in successfully!</p>
                <img id="user-photo" class="w-16 h-16 rounded-full mx-auto shadow-lg border-2 border-indigo-400" src="https://placehold.co/64x64/E0E7FF/4338CA?text=U" alt="User Photo" onerror="this.onerror=null;this.src='https://placehold.co/64x64/E0E7FF/4338CA?text=U';">
                <div class="bg-indigo-100 p-4 rounded-lg text-left">
                    <p class="text-sm font-semibold text-indigo-700">Display Name:</p>
                    <p id="user-display-name" class="break-all font-medium text-base mt-1 text-indigo-800"></p>
                </div>
                <div class="bg-indigo-100 p-4 rounded-lg text-left">
                    <p class="text-sm font-semibold text-indigo-700">Email:</p>
                    <p id="user-email" class="break-all font-mono text-xs mt-1 text-indigo-800"></p>
                </div>
                <div class="bg-indigo-100 p-4 rounded-lg text-left">
                    <p class="text-sm font-semibold text-indigo-700">User ID (UID):</p>
                    <p id="user-id" class="break-all font-mono text-xs mt-1 text-indigo-800"></p>
                </div>

                <button id="signout-btn"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                    Sign Out
                </button>
            </div>

            <!-- Message Area -->
            <div id="message" class="mt-4 p-3 rounded-lg text-sm text-center hidden w-full"></div>
        </div>
    </div>

    <!-- Firebase SDK Modules -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
            // New Import: Function to update user profile (set name)
            updateProfile,
            // Email/Password methods
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            // Google Sign-In methods
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Your web app's Firebase configuration (Provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyBfdNQiv_0Hq4BLD2d3fqh955yxNzMoqZg",
            authDomain: "login-me-vrinda.firebaseapp.com",
            projectId: "login-me-vrinda",
            storageBucket: "login-me-vrinda.firebasestorage.app",
            messagingSenderId: "1019370299171",
            appId: "1:1019370299171:web:9ce95e6b39da03e1cd3696",
            measurementId: "G-SBZTQEXQJ8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); 
        const auth = getAuth(app);
        
        // Providers
        const googleProvider = new GoogleAuthProvider();

        // ----------------------------------------------------------------------
        // 1. DOM Elements and State
        // ----------------------------------------------------------------------

        // DOM Elements
        const loadingStateEl = document.getElementById('loading-state');
        const authContainerEl = document.getElementById('auth-container');
        const profileContainerEl = document.getElementById('profile-container');
        const authTitleEl = document.getElementById('auth-title');
        
        // Email/Password Form Elements
        const authFormEl = document.getElementById('auth-form');
        const displayNameEl = document.getElementById('display-name'); // New DOM reference
        const nameFieldContainerEl = document.getElementById('name-field-container'); // New container reference
        const emailEl = document.getElementById('email');
        const passwordEl = document.getElementById('password');
        const submitBtnEl = document.getElementById('submit-btn');
        const toggleAuthBtnEl = document.getElementById('toggle-auth-btn');
        const togglePromptEl = document.getElementById('toggle-prompt');
        
        // Google Button
        const googleSignInBtnEl = document.getElementById('google-signin-btn');
        
        // Profile Elements
        const signoutBtnEl = document.getElementById('signout-btn');
        const userIdEl = document.getElementById('user-id');
        const userEmailEl = document.getElementById('user-email');
        const userDisplayNameEl = document.getElementById('user-display-name');
        const userPhotoEl = document.getElementById('user-photo');
        const messageEl = document.getElementById('message');

        let isSignUpMode = false; // State to track Email/Password mode

        /**
         * Utility to display status or error messages.
         * @param {string} text The message content.
         * @param {string} type 'success' or 'error'.
         */
        function displayMessage(text, type) {
            messageEl.textContent = text;
            messageEl.className = 'mt-4 p-3 rounded-lg text-sm text-center w-full';
            if (type === 'error') {
                messageEl.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageEl.classList.add('bg-green-100', 'text-green-700');
            }
            messageEl.classList.remove('hidden');
        }

        /**
         * Toggles the UI between Email/Password Login and Signup modes.
         * @param {boolean} signUpMode If true, sets mode to Signup.
         */
        function setAuthMode(signUpMode) {
            isSignUpMode = signUpMode;
            authFormEl.reset(); // Clear inputs
            messageEl.classList.add('hidden');

            if (isSignUpMode) {
                // Show name field and make it required for signup
                nameFieldContainerEl.classList.remove('hidden');
                displayNameEl.setAttribute('required', 'required');

                authTitleEl.textContent = "Sign Up with Email";
                submitBtnEl.textContent = "Sign Up";
                togglePromptEl.textContent = "Already have an account?";
                toggleAuthBtnEl.textContent = "Sign In";
            } else {
                // Hide name field and remove required attribute for signin
                nameFieldContainerEl.classList.add('hidden');
                displayNameEl.removeAttribute('required');

                authTitleEl.textContent = "Sign In with Email";
                submitBtnEl.textContent = "Sign In";
                togglePromptEl.textContent = "Don't have an account?";
                toggleAuthBtnEl.textContent = "Sign Up";
            }
        }

        /**
         * Updates the UI based on the current authentication state.
         * @param {import("firebase/auth").User | null} user The currently authenticated user object.
         */
        function updateUI(user) {
            loadingStateEl.classList.add('hidden');
            
            // Check if the user is authenticated (not null)
            if (user) {
                // LOGGED IN State
                authContainerEl.classList.add('hidden');
                profileContainerEl.classList.remove('hidden');
                authTitleEl.textContent = "Your Profile";

                // Populate profile details
                userIdEl.textContent = user.uid;
                userEmailEl.textContent = user.email || 'N/A';
                // Display the name, or fall back if not available
                userDisplayNameEl.textContent = user.displayName || (user.email ? user.email.split('@')[0] : 'No Display Name'); 
                userPhotoEl.src = user.photoURL || 'https://placehold.co/64x64/E0E7FF/4338CA?text=U';


            } else {
                // LOGGED OUT State
                profileContainerEl.classList.add('hidden');
                authContainerEl.classList.remove('hidden');
                setAuthMode(false); // Default to Sign In mode
            }
        }

        // ----------------------------------------------------------------------
        // 2. Authentication Handlers
        // ----------------------------------------------------------------------

        /**
         * Handles the form submission (Email/Password Sign In or Sign Up).
         * @param {Event} e The submit event.
         */
        async function handleEmailAuth(e) {
            e.preventDefault();
            messageEl.classList.add('hidden');
            const email = emailEl.value;
            const password = passwordEl.value;
            const name = displayNameEl.value.trim(); // Get name and trim whitespace
            
            submitBtnEl.disabled = true;
            const originalText = isSignUpMode ? "Sign Up" : "Sign In";
            submitBtnEl.textContent = isSignUpMode ? "Processing..." : "Processing...";

            // 1. Client-Side Validation
            if (password.length < 6) {
                displayMessage('Password must be at least 6 characters long.', 'error');
                submitBtnEl.disabled = false;
                submitBtnEl.textContent = originalText;
                return; // Stop execution if validation fails
            }

            if (isSignUpMode && !name) {
                displayMessage('Please enter a Display Name for your account.', 'error');
                submitBtnEl.disabled = false;
                submitBtnEl.textContent = originalText;
                return; // Stop execution if validation fails
            }

            try {
                if (isSignUpMode) {
                    // Sign Up
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // Update the user's profile with the name after successful creation
                    await updateProfile(userCredential.user, {
                        displayName: name
                    });

                    displayMessage('Success! Account created and you are now logged in.', 'success');
                } else {
                    // Sign In
                    await signInWithEmailAndPassword(auth, email, password);
                    displayMessage('Success! You are now logged in.', 'success');
                }
            } catch (error) {
                console.error("Email Authentication Error:", error);
                let errorMessage = error.message.replace('Firebase: ', '');

                if (!isSignUpMode && error.code === 'auth/user-not-found') {
                    // Friendly message for sign-in when account doesn't exist
                    errorMessage = "Account not found with this email. Please switch to the 'Sign Up' mode below to create an account.";
                } else if (isSignUpMode && error.code === 'auth/email-already-in-use') {
                    // Friendly error for sign-up if email already exists
                    errorMessage = "This email is already registered. Please switch to the 'Sign In' mode to log in.";
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = "Invalid email or password. Please check your credentials.";
                }
                
                displayMessage(errorMessage, 'error');
            } finally {
                submitBtnEl.disabled = false;
                submitBtnEl.textContent = originalText;
            }
        }

        /**
         * Handles the Google Sign-In using a popup window.
         */
        async function handleGoogleSignIn() {
            googleSignInBtnEl.disabled = true;
            googleSignInBtnEl.innerHTML = `
                <div class="animate-spin inline-block w-4 h-4 mr-2 border-2 border-current border-t-transparent rounded-full"></div> Connecting...
            `;
            messageEl.classList.add('hidden');

            try {
                await signInWithPopup(auth, googleProvider);
                displayMessage('Successfully signed in with Google!', 'success');
            } catch (error) {
                if (error.code === 'auth/popup-closed-by-user') {
                    displayMessage('Sign-in cancelled. Please try again.', 'error');
                } else {
                    console.error("Google Sign-In Error:", error);
                    let errorMessage = error.message.replace('Firebase: ', '');
                    displayMessage(`Google Sign-in failed: ${errorMessage}`, 'error');
                }
            } finally {
                googleSignInBtnEl.disabled = false;
                googleSignInBtnEl.innerHTML = `
                    <svg class="google-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                        <!-- Blue -->
                        <path fill="#4285F4" d="M386.9,235.8c0-14.8-1.3-29.2-3.8-43.2H256v82.7h72.4c-3.1,17.2-12.1,31.7-25.7,41.9v53.3h68.8C421.1,380.2,453.7,314.1,453.7,256C453.7,247.9,453.1,241.2,452.4,235.8z"/>
                        <!-- Red -->
                        <path fill="#EA4335" d="M256,453.7c33.5,0,62.8-11.3,83.7-30.7l-68.8-53.3c-18.7,12.5-43,20-68.8,20c-53.3,0-98.3-35.8-114.6-84.5h-71.1v55.5C70.6,400.9,157.9,453.7,256,453.7z"/>
                        <!-- Yellow -->
                        <path fill="#FBBC05" d="M141.4,279.7c-3.6-10.4-5.6-21.5-5.6-32.9s2-22.5,5.6-32.9v-55.5h-71.1C58.3,191.6,50.7,222.9,50.7,246.8s7.6,55.2,19.6,83.9L141.4,279.7z"/>
                        <!-- Green -->
                        <path fill="#34A853" d="M256,158c28.8,0,54.7,9.9,75.1,29.3L400,111.4c-20.9-19.4-50.2-30.7-83.7-30.7c-98.1,0-185.4,52.8-232.7,129.9l71.1,55.5C157.7,193.8,202.7,158,256,158z"/>
                    </svg>
                    Sign in with Google
                `;
            }
        }

        /**
         * Handles the Sign Out process.
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                displayMessage('You have been signed out successfully.', 'success');
            } catch (error) {
                console.error("Sign Out Error:", error);
                displayMessage(`Sign Out Failed: ${error.message}`, 'error');
            }
        }

        // ----------------------------------------------------------------------
        // 3. Event Listeners and Initialization
        // ----------------------------------------------------------------------

        // Email/Password Form submission listener
        authFormEl.addEventListener('submit', handleEmailAuth);

        // Toggle button listener (Switches form between Login and Signup)
        toggleAuthBtnEl.addEventListener('click', () => {
            setAuthMode(!isSignUpMode);
        });

        // Google Sign-In listener
        googleSignInBtnEl.addEventListener('click', handleGoogleSignIn);

        // Sign out button listener
        signoutBtnEl.addEventListener('click', handleSignOut);

        // Listen for real-time authentication state changes
        onAuthStateChanged(auth, (user) => {
            updateUI(user);
        });
        
    </script>
</body>
</html>