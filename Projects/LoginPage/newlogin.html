<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Auth System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3ffce; /* Light, soft background */
        }
        /* Custom style for primary button color */
        .btn-primary {
            background-color: #1e40af; /* Blue-800 */
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #1e3a8a; /* Blue-900 */
        }
        /* Custom style for Google button */
        .btn-google {
            background-color: white;
            color: #1f2937; /* Gray-800 */
            border: 1px solid #d1d5db; /* Gray-300 */
            transition: all 0.2s ease-in-out;
        }
        .btn-google:hover {
            background-color: #f9fafb; /* Gray-50 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .btn-google:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
            border-color: #e5e7eb;
        }
        /* Dark mode styles */
        .dark body {
            background-color: #111827; /* Gray-900 */
        }
        .dark .btn-google {
            background-color: #374151; /* Gray-700 */
            color: #f9fafb; /* Gray-50 */
            border-color: #4b5563; /* Gray-600 */
        }
        .dark .btn-google:hover {
            background-color: #4b5563; /* Gray-600 */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="fixed top-4 right-4 p-2 rounded-full text-gray-500 bg-white dark:bg-gray-800 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 shadow-md">
        <svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
        <svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zM5 11a1 1 0 100-2H4a1 1 0 100 2h1zM8 16a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z"></path></svg>
    </button>

    <div class="w-full max-w-md">

        <!-- Auth Card Container -->
        <div id="auth-container" class="bg-white dark:bg-gray-800 shadow-2xl border border-gray-100 dark:border-gray-700 rounded-xl overflow-hidden transition-all duration-500">
            
            <div class="p-8 pb-4 bg-white dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700">
                <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white">
                    <span id="view-title">Sign In</span>
                </h1>
                <p id="view-subtitle" class="text-gray-600 dark:text-gray-400 mt-1">Access your account or create a new one instantly.</p>
            </div>

            <div class="p-8 space-y-6">
                <div id="status-message" class="hidden p-3 rounded-lg text-sm transition-all duration-300"></div>
                <button id="google-sign-in-button" onclick="signInWithGoogle()" class="btn-google w-full flex items-center justify-center py-3 px-4 rounded-lg shadow-sm text-base font-medium" disabled>
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M44.5 20H24v8.5h11.8c-.8 5.7-5.7 9.8-11.8 9.8-7.3 0-13.3-6-13.3-13.3S16.7 13.7 24 13.7c3.3 0 5.8 1.4 7.5 3.1l6.4-6.4C34.7 7.2 29.7 5 24 5 13.8 5 5.5 13.3 5.5 24S13.8 43 24 43c10.2 0 17.5-7.4 17.5-17.5 0-1.5-.2-2.9-.4-4.2H24v-8.5h20.5z" fill="#4285F4"/><path d="M24 43c5.3 0 9.7-1.8 12.5-4.9l-6.4-6.4c-1.7 1.7-4.2 3.1-7.5 3.1-6.1 0-11.1-4.1-13.3-9.8h-8.5C5.5 34.7 13.8 43 24 43z" fill="#34A853"/><path d="M5.5 24c0-1.5.2-2.9.4-4.2h8.5c-.5 2.6-.5 5.2 0 7.8H5.9c-.2-1.3-.4-2.7-.4-4-4.2z" fill="#FBBC05"/><path d="M24 13.7c3.3 0 5.8 1.4 7.5 3.1l6.4-6.4C34.7 7.2 29.7 5 24 5 13.8 5 5.5 13.3 5.5 24c0 1.5.2 2.9.4 4.2h8.5c.5-2.6.5-5.2 0-7.8h-8.5C5.7 17.1 5.5 15.6 5.5 14z" fill="#EA4335"/></svg>
                    Continue with Google
                </button>
                <div class="relative flex items-center justify-center">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300 dark:border-gray-600"></div></div>
                    <div class="relative bg-white dark:bg-gray-800 px-3 text-sm text-gray-500 dark:text-gray-400">OR</div>
                </div>
                <form id="form-login" class="space-y-6" onsubmit="event.preventDefault(); handleAuth('login')">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                        <input type="email" id="login-email" autocomplete="email" required class="w-full px-4 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition duration-150" placeholder="your@email.com">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                        <div class="relative">
                            <input type="password" id="login-password" autocomplete="current-password" required class="w-full px-4 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition duration-150 pr-10" placeholder="••••••••">
                            <button type="button" onclick="togglePasswordVisibility('login-password', 'login-eye-icon')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 dark:text-gray-400">
                                <svg id="login-eye-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <a href="#" onclick="showView('signup'); return false;" class="text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-500 font-medium transition-colors duration-150">Don't have an account? Sign Up</a>
                        <button type="submit" class="btn-primary py-2 px-6 rounded-lg text-base font-medium text-white shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Log In</button>
                    </div>
                </form>
                <form id="form-signup" class="space-y-6 hidden" onsubmit="event.preventDefault(); handleAuth('signup')">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name</label>
                        <input type="text" id="signup-name" autocomplete="name" required class="w-full px-4 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition duration-150" placeholder="John Doe">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                        <input type="email" id="signup-email" autocomplete="email" required class="w-full px-4 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition duration-150" placeholder="your@email.com">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                        <div class="relative">
                            <input type="password" id="signup-password" autocomplete="new-password" required minlength="6" class="w-full px-4 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg focus:border-blue-600 focus:ring-1 focus:ring-blue-600 transition duration-150 pr-10" placeholder="Minimum 6 characters">
                            <button type="button" onclick="togglePasswordVisibility('signup-password', 'signup-eye-icon')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 dark:text-gray-400">
                                <svg id="signup-eye-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <a href="#" onclick="showView('login'); return false;" class="text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-500 font-medium transition-colors duration-150">Already have an account? Log In</a>
                        <button type="submit" class="btn-primary py-2 px-6 rounded-lg text-base font-medium text-white shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Sign Up</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Logged-In View -->
        <div id="logged-in-container" class="hidden bg-white dark:bg-gray-800 shadow-2xl border border-gray-100 dark:border-gray-700 rounded-xl p-8 text-center">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Welcome!</h2>
            <p id="welcome-message" class="mt-2 text-gray-600 dark:text-gray-400 truncate"></p>
            <button onclick="signOutUser()" class="mt-6 w-full btn-primary py-3 px-6 rounded-lg text-base font-medium text-white shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Sign Out
            </button>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables
        let auth, db;
        
        // --- Utility ---
        function displayStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden'); // Ensure message is visible
            statusDiv.className = 'p-3 rounded-lg text-sm transition-all duration-300';
            if (type === 'error') {
                statusDiv.classList.add('bg-red-100', 'text-red-700', 'dark:bg-red-900/30', 'dark:text-red-400');
            } else {
                statusDiv.classList.add('bg-green-100', 'text-green-700', 'dark:bg-green-900/30', 'dark:text-green-400');
            }
            // Auto-hide after 5 seconds
            setTimeout(() => statusDiv.classList.add('hidden'), 5000);
        }

        // --- Firebase Initialization ---
        function initFirebase() {
            try {
                // !!! FINAL CONFIGURATION FOR PROJECT: vrinda-company. Updated API Key. !!!
                const firebaseConfig = {
                    apiKey: "AIzaSyC-nrC-zFQ7xkN5r86McpqUfMHHYcQSVO0", // <-- NEW KEY INSERTED HERE
                    authDomain: "vrinda-company.firebaseapp.com",
                    projectId: "vrinda-company",
                    storageBucket: "vrinda-company.appspot.com",
                    messagingSenderId: "261821848203",
                    appId: "1:261821848203:web:7bdb6d61d7f786eb5928e" 
                };
                // !!! END OF CONFIGURATION !!!

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                document.getElementById('google-sign-in-button').disabled = false;
                document.getElementById('google-sign-in-button').textContent = 'Continue with Google';

                // Monitor authentication state
                onAuthStateChanged(auth, (user) => {
                    const authContainer = document.getElementById('auth-container');
                    const loggedInContainer = document.getElementById('logged-in-container');
                    if (user && !user.isAnonymous) {
                        document.getElementById('welcome-message').textContent = `Logged in as ${user.displayName || user.email}`;
                        authContainer.classList.add('hidden');
                        loggedInContainer.classList.remove('hidden');
                    } else {
                        authContainer.classList.remove('hidden');
                        loggedInContainer.classList.add('hidden');
                    }
                });
                console.log("Firebase Initialized Successfully.");
            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                displayStatus(`Critical Error: Firebase failed to initialize. ${error.message}`, 'error');
                document.getElementById('google-sign-in-button').textContent = 'Initialization Failed';
            }
        }
        
        // --- Firestore ---
        async function createUserProfileDocument(user, additionalData = {}) {
            if (!user) return;
            // NOTE: Using a simple 'users' collection for demo, not the full Canvas path
            const userRef = doc(db, 'users', user.uid); 
            const { displayName, email } = user;
            const createdAt = serverTimestamp();
            try {
                await setDoc(userRef, {
                    displayName: displayName || additionalData.displayName,
                    email,
                    createdAt,
                    ...additionalData,
                }, { merge: true });
            } catch (error) {
                console.error("Error creating user profile:", error);
                displayStatus("Could not save user profile.", "error");
            }
        }

        // --- Authentication Logic (Email/Password) ---
        window.handleAuth = async function(mode) {
            const email = document.getElementById(`${mode}-email`).value;
            const password = document.getElementById(`${mode}-password`).value;
            displayStatus(`Attempting ${mode}...`, 'success'); // Show loading state
            try {
                if (mode === 'signup') {
                    const name = document.getElementById('signup-name').value;
                    if (!name) {
                        displayStatus("Please enter your full name.", "error");
                        return;
                    }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    await updateProfile(user, { displayName: name });
                    await createUserProfileDocument(user, { displayName: name });
                    displayStatus("Sign Up successful! Redirecting...", 'success');
                } else { // mode === 'login'
                    await signInWithEmailAndPassword(auth, email, password);
                    displayStatus("Login successful! Redirecting...", 'success');
                }
            } catch (error) {
                console.error(`${mode} Error:`, error);
                let message = "An unknown error occurred.";
                switch (error.code) {
                    case 'auth/email-already-in-use': message = "This email address is already in use by another account."; break;
                    case 'auth/weak-password': message = "Password should be at least 6 characters."; break;
                    case 'auth/invalid-credential': message = "Incorrect email or password. Please try again."; break;
                    case 'auth/user-not-found': 
                    case 'auth/wrong-password':
                        message = "Invalid email or password."; 
                        break;
                    default: message = `Authentication failed: ${error.message}`;
                }
                displayStatus(message, 'error');
            }
        }

        // --- Authentication Logic (Google Pop-up) ---
        window.signInWithGoogle = async function() {
            displayStatus(`Attempting Google Sign-In...`, 'success'); // Show loading state
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                // Create a user profile in Firestore for new Google users as well
                await createUserProfileDocument(result.user);
                displayStatus("Google Sign-In successful! Redirecting...", 'success');
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                let message = `Google Sign-In Failed: ${error.message}`;
                if (error.code === 'auth/popup-closed-by-user') {
                    message = 'Google Sign-In window was closed.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    // This is the error we are trying to fix!
                    message = "Sign-In Failed: Error 400. Your domain is NOT authorized in the Firebase Console's Auth settings (Sign-in method -> Authorized domains).";
                } else if (error.code === 'auth/api-key-not-valid') {
                    message = "API Key Error: Check Google Cloud Console API restrictions (Identity Toolkit API must be enabled for this specific key).";
                }
                displayStatus(message, 'error');
            }
        }

        // --- Sign Out Logic ---
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                displayStatus("Successfully signed out.", 'success');
            } catch (error) {
                console.error("Sign Out Error:", error);
                displayStatus("Error signing out.", "error");
            }
        }
        
        // --- UI Logic ---
        window.showView = function(view) {
            document.getElementById('form-login').classList.toggle('hidden', view !== 'login');
            document.getElementById('form-signup').classList.toggle('hidden', view !== 'signup');
            document.getElementById('view-title').textContent = view === 'login' ? 'Sign In' : 'Create Account';
            document.getElementById('view-subtitle').textContent = view === 'login' 
                ? 'Access your account or create a new one.' 
                : 'Join us today. It only takes a minute!';
            document.getElementById('status-message').classList.add('hidden');
        }

        window.togglePasswordVisibility = function(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const eyeIcon = document.getElementById(iconId);
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7C3.732 7.943 7.523 5 12 5c1.281 0 2.52.246 3.688.691M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 2l20 20" />`;
            } else {
                passwordInput.type = 'password';
                eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`;
            }
        }
        
        // --- Theme Management ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');

        function applyTheme(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
                localStorage.theme = 'dark';
            } else {
                document.documentElement.classList.remove('dark');
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
                localStorage.theme = 'light';
            }
        }

        themeToggleBtn.addEventListener('click', () => {
            applyTheme(!document.documentElement.classList.contains('dark'));
        });

        function initializeTheme() {
            const isSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');
            applyTheme(savedTheme === 'dark' || (!savedTheme && isSystemDark));

            // Listen for changes in system theme
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) { // Only apply if user hasn't set a preference
                    applyTheme(e.matches);
                }
            });
        }

        // Initialize on window load
        window.onload = () => {
            initializeTheme();
            initFirebase();
        };
    </script>
</body>
</html>